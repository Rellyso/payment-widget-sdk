<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test Shadow DOM - Payment Widget</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 1200px;
      margin: 40px auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }

    .test-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 6px;
      border-left: 4px solid #4CAF50;
    }

    .test-section h2 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 4px;
      font-weight: 600;
      font-size: 14px;
      margin-left: 10px;
    }

    .status.success {
      background: #4CAF50;
      color: white;
    }

    .status.error {
      background: #f44336;
      color: white;
    }

    .status.warning {
      background: #ff9800;
      color: white;
    }

    .info-box {
      background: #e3f2fd;
      border: 1px solid #2196F3;
      border-radius: 4px;
      padding: 15px;
      margin: 15px 0;
    }

    .info-box strong {
      color: #1976D2;
    }

    .code-block {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      margin: 10px 0;
    }

    button {
      background: #2196F3;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-right: 10px;
      margin-bottom: 10px;
    }

    button:hover {
      background: #1976D2;
    }

    button.secondary {
      background: #757575;
    }

    button.secondary:hover {
      background: #616161;
    }

    #console-output {
      background: #263238;
      color: #aed581;
      padding: 15px;
      border-radius: 4px;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      line-height: 1.6;
    }

    .log-entry {
      margin: 5px 0;
    }

    .log-entry.info {
      color: #64B5F6;
    }

    .log-entry.success {
      color: #81C784;
    }

    .log-entry.error {
      color: #E57373;
    }

    .log-entry.warning {
      color: #FFB74D;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üîç Shadow DOM Test - Payment Widget</h1>
    <p class="subtitle">Teste e verifique se o Shadow DOM est√° funcionando corretamente</p>

    <!-- Test Section 1: Shadow DOM Detection -->
    <div class="test-section">
      <h2>1Ô∏è‚É£ Detec√ß√£o de Shadow DOM <span id="status-1" class="status">Aguardando...</span></h2>
      <p>Verifica se o navegador suporta Shadow DOM e se ele foi criado corretamente.</p>
      <div id="result-1" class="info-box" style="display: none;"></div>
    </div>

    <!-- Test Section 2: Style Isolation -->
    <div class="test-section">
      <h2>2Ô∏è‚É£ Isolamento de Estilos <span id="status-2" class="status">Aguardando...</span></h2>
      <p>Testa se os estilos CSS est√£o isolados entre a p√°gina e o Shadow DOM.</p>
      <div id="result-2" class="info-box" style="display: none;"></div>
    </div>

    <!-- Test Section 3: DOM Inspection -->
    <div class="test-section">
      <h2>3Ô∏è‚É£ Inspe√ß√£o do DOM <span id="status-3" class="status">Aguardando...</span></h2>
      <p>Mostra a estrutura do DOM e do Shadow DOM.</p>
      <div id="result-3" class="info-box" style="display: none;"></div>
    </div>

    <!-- Control Buttons -->
    <div style="margin: 30px 0;">
      <button onclick="initWidget()">üöÄ Inicializar Widget</button>
      <button onclick="openWidget()" class="secondary">üìñ Abrir Widget</button>
      <button onclick="closeWidget()" class="secondary">üö™ Fechar Widget</button>
      <button onclick="runAllTests()" class="secondary">üß™ Executar Testes</button>
      <button onclick="inspectWidget()" class="secondary">üîç Inspecionar Widget</button>
      <button onclick="clearConsole()" class="secondary">üóëÔ∏è Limpar Console</button>
    </div>

    <!-- Console Output -->
    <div class="test-section">
      <h2>üìã Console de Logs</h2>
      <div id="console-output"></div>
    </div>

    <!-- Instructions -->
    <div class="info-box" style="margin-top: 30px;">
      <h3 style="margin-top: 0;">üí° Como verificar no DevTools:</h3>
      <ol>
        <li>Abra o DevTools (F12 ou Cmd+Option+I no Mac)</li>
        <li>V√° para a aba "Elements" ou "Inspetor"</li>
        <li>Procure por um elemento com <code>#shadow-root (open)</code></li>
        <li>Expanda o shadow-root para ver o conte√∫do isolado</li>
        <li>Tente selecionar elementos dentro do Shadow DOM - eles estar√£o isolados</li>
      </ol>
    </div>
  </div>

  <!-- Widget Bootstrap Script -->
  <script>
    // Console Logger
    function log(message, type = 'info') {
      const consoleOutput = document.getElementById('console-output');
      const timestamp = new Date().toLocaleTimeString();
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `[${timestamp}] ${message}`;
      consoleOutput.appendChild(entry);
      consoleOutput.scrollTop = consoleOutput.scrollHeight;
    }

    function clearConsole() {
      document.getElementById('console-output').innerHTML = '';
      log('Console limpo', 'info');
    }

    // Initialize Widget
    async function initWidget() {
      log('üöÄ Iniciando widget...', 'info');

      try {
        // Load bootstrap script
        if (!window.PaymentWidget) {
          log('Carregando script do bootstrap...', 'info');
          const script = document.createElement('script');
          script.src = 'https://d2x7cg3k3on9lk.cloudfront.net/widget-bootstrap.v1.min.js';
          script.async = true;

          script.onload = async () => {
            log('‚úÖ Bootstrap carregado com sucesso', 'success');
            await actualInit();
          };

          script.onerror = () => {
            log('‚ùå Erro ao carregar bootstrap', 'error');
          };

          document.head.appendChild(script);
        } else {
          await actualInit();
        }
      } catch (error) {
        log(`‚ùå Erro na inicializa√ß√£o: ${error.message}`, 'error');
      }
    }

    async function actualInit() {
      try {
        await window.PaymentWidget.init({
          merchantId: 'test_shadow_dom_123',
          environment: 'staging',
          theme: {
            primaryColor: '#2196F3',
            secondaryColor: '#4CAF50'
          },
          onOpen: () => {
            log('üîî Callback onOpen chamado', 'success');
          },
          onClose: () => {
            log('üîî Callback onClose chamado', 'info');
          },
          onError: (error) => {
            log(`üîî Callback onError: ${error.message}`, 'error');
          }
        });

        log('‚úÖ Widget inicializado com sucesso', 'success');

        // Log container state
        const container = document.querySelector('[id^="__payment_widget_root__"]');
        if (container) {
          const styles = window.getComputedStyle(container);
          log(`üì¶ Container display: ${styles.display}`, 'info');
          log(`üì¶ Container pointer-events: ${styles.pointerEvents}`, 'info');
          log(`üì¶ Container z-index: ${styles.zIndex}`, 'info');
        }

        // Run tests automatically after init
        setTimeout(() => {
          runAllTests();
        }, 1000);

      } catch (error) {
        log(`‚ùå Erro ao inicializar: ${error.message}`, 'error');
      }
    }

    function openWidget() {
      if (window.PaymentWidget) {
        log('üìñ Chamando PaymentWidget.open()...', 'info');
        window.PaymentWidget.open();

        // Check state after opening
        setTimeout(() => {
          const state = window.PaymentWidget.getState();
          log(`üîç Estado ap√≥s open: isOpen=${state.isOpen}, isLoaded=${state.isLoaded}`, 'info');

          const container = document.querySelector('[id^="__payment_widget_root__"]');
          if (container) {
            const styles = window.getComputedStyle(container);
            log(`ÔøΩ Container ap√≥s open - display: ${styles.display}`, 'info');
            log(`üì¶ Container ap√≥s open - visibility: ${styles.visibility}`, 'info');

            if (container.shadowRoot) {
              const rootElement = container.shadowRoot.getElementById('pw-root');
              if (rootElement) {
                log(`‚úÖ Root element encontrado no Shadow DOM`, 'success');
                log(`üì¶ Root element children: ${rootElement.children.length}`, 'info');

                // Check if React rendered anything
                const reactRoot = rootElement.querySelector('[class*="payment"]');
                if (reactRoot) {
                  log(`‚úÖ Componente React renderizado`, 'success');
                } else {
                  log(`‚ö†Ô∏è Componente React n√£o encontrado`, 'warning');
                }
              } else {
                log(`‚ùå Root element n√£o encontrado`, 'error');
              }
            }
          }
        }, 500);
      } else {
        log('‚ö†Ô∏è Widget n√£o inicializado. Clique em "Inicializar Widget" primeiro.', 'warning');
      }
    }

    function closeWidget() {
      if (window.PaymentWidget) {
        log('üö™ Chamando PaymentWidget.close()...', 'info');
        window.PaymentWidget.close();

        setTimeout(() => {
          const state = window.PaymentWidget.getState();
          log(`üîç Estado ap√≥s close: isOpen=${state.isOpen}`, 'info');
        }, 300);
      } else {
        log('‚ö†Ô∏è Widget n√£o inicializado.', 'warning');
      }
    }

    function inspectWidget() {
      log('üîç Inspecionando widget...', 'info');

      if (!window.PaymentWidget) {
        log('‚ùå PaymentWidget n√£o dispon√≠vel', 'error');
        return;
      }

      const state = window.PaymentWidget.getState();
      log(`üìä Estado: isOpen=${state.isOpen}, isLoaded=${state.isLoaded}`, 'info');

      const container = document.querySelector('[id^="__payment_widget_root__"]');
      if (!container) {
        log('‚ùå Container n√£o encontrado', 'error');
        return;
      }

      log(`‚úÖ Container: ${container.id}`, 'success');

      const styles = window.getComputedStyle(container);
      log(`üì¶ Container styles:`, 'info');
      log(`   display: ${styles.display}`, 'info');
      log(`   visibility: ${styles.visibility}`, 'info');
      log(`   pointer-events: ${styles.pointerEvents}`, 'info');
      log(`   z-index: ${styles.zIndex}`, 'info');

      if (container.shadowRoot) {
        log(`‚úÖ Shadow DOM encontrado`, 'success');

        const rootElement = container.shadowRoot.getElementById('pw-root');
        if (rootElement) {
          log(`‚úÖ Root element encontrado`, 'success');
          log(`   Children: ${rootElement.children.length}`, 'info');

          // Check for modal/overlay
          const allElements = rootElement.querySelectorAll('*');
          log(`   Total elementos: ${allElements.length}`, 'info');

          const overlay = rootElement.querySelector('[class*="overlay"], [class*="modal"], [class*="backdrop"]');
          if (overlay) {
            log(`‚úÖ Modal/Overlay encontrado`, 'success');
          } else {
            log(`‚ö†Ô∏è Modal/Overlay n√£o encontrado`, 'warning');
          }
        }
      }
    }

    // Test Functions
    function runAllTests() {
      log('üß™ Executando todos os testes...', 'info');
      testShadowDOMDetection();
      testStyleIsolation();
      testDOMInspection();
    }

    function testShadowDOMDetection() {
      log('Test 1: Detectando Shadow DOM...', 'info');
      const status = document.getElementById('status-1');
      const result = document.getElementById('result-1');

      // Check if Shadow DOM is supported
      const supported = 'attachShadow' in Element.prototype;

      if (!supported) {
        status.className = 'status error';
        status.textContent = 'N√£o Suportado';
        result.innerHTML = '<strong>‚ùå Shadow DOM n√£o √© suportado neste navegador.</strong><br>O widget usar√° iframe como fallback.';
        result.style.display = 'block';
        log('‚ùå Shadow DOM n√£o suportado pelo navegador', 'error');
        return;
      }

      log('‚úÖ Shadow DOM √© suportado pelo navegador', 'success');

      // Find widget container
      const container = document.querySelector('[id^="__payment_widget_root__"]');

      if (!container) {
        status.className = 'status warning';
        status.textContent = 'Widget n√£o encontrado';
        result.innerHTML = '<strong>‚ö†Ô∏è Container do widget n√£o encontrado.</strong><br>Inicialize o widget primeiro.';
        result.style.display = 'block';
        log('‚ö†Ô∏è Container do widget n√£o encontrado', 'warning');
        return;
      }

      log(`‚úÖ Container encontrado: ${container.id}`, 'success');

      // Check if Shadow DOM exists
      if (container.shadowRoot) {
        status.className = 'status success';
        status.textContent = '‚úÖ Funcionando';
        result.innerHTML = `
          <strong>‚úÖ Shadow DOM criado com sucesso!</strong><br><br>
          <strong>Detalhes:</strong><br>
          ‚Ä¢ Mode: ${container.shadowRoot.mode}<br>
          ‚Ä¢ Host: ${container.id}<br>
          ‚Ä¢ Children: ${container.shadowRoot.children.length} elemento(s)<br>
          ‚Ä¢ Root element: ${container.shadowRoot.getElementById('pw-root') ? '‚úÖ Encontrado' : '‚ùå N√£o encontrado'}
        `;
        result.style.display = 'block';
        log('‚úÖ Shadow DOM criado e funcionando corretamente', 'success');
        log(`   Mode: ${container.shadowRoot.mode}`, 'info');
        log(`   Children: ${container.shadowRoot.children.length}`, 'info');
      } else {
        // Check for iframe fallback
        const iframe = container.querySelector('iframe');
        if (iframe) {
          status.className = 'status warning';
          status.textContent = 'Iframe Fallback';
          result.innerHTML = '<strong>‚ö†Ô∏è Usando iframe como fallback.</strong><br>Shadow DOM n√£o foi criado, mas o iframe fornece isolamento similar.';
          result.style.display = 'block';
          log('‚ö†Ô∏è Usando iframe fallback', 'warning');
        } else {
          status.className = 'status error';
          status.textContent = '‚ùå Erro';
          result.innerHTML = '<strong>‚ùå Shadow DOM n√£o criado e nenhum fallback encontrado.</strong>';
          result.style.display = 'block';
          log('‚ùå Nenhum isolamento encontrado (Shadow DOM ou iframe)', 'error');
        }
      }
    }

    function testStyleIsolation() {
      log('Test 2: Testando isolamento de estilos...', 'info');
      const status = document.getElementById('status-2');
      const result = document.getElementById('result-2');

      const container = document.querySelector('[id^="__payment_widget_root__"]');

      if (!container || !container.shadowRoot) {
        status.className = 'status warning';
        status.textContent = 'N√£o testado';
        result.innerHTML = '<strong>‚ö†Ô∏è Shadow DOM n√£o dispon√≠vel para teste.</strong>';
        result.style.display = 'block';
        log('‚ö†Ô∏è Shadow DOM n√£o dispon√≠vel para teste de estilos', 'warning');
        return;
      }

      // Test style isolation
      const testDiv = document.createElement('div');
      testDiv.className = 'test-isolation';
      testDiv.style.cssText = 'background: red; color: white; padding: 10px;';
      testDiv.textContent = 'Este elemento est√° FORA do Shadow DOM';

      const shadowTestDiv = container.shadowRoot.querySelector('#pw-root');

      if (shadowTestDiv) {
        status.className = 'status success';
        status.textContent = '‚úÖ Isolado';
        result.innerHTML = `
          <strong>‚úÖ Estilos est√£o isolados corretamente!</strong><br><br>
          <strong>O que isso significa:</strong><br>
          ‚Ä¢ Estilos da p√°gina n√£o afetam o widget<br>
          ‚Ä¢ Estilos do widget n√£o afetam a p√°gina<br>
          ‚Ä¢ Classes CSS n√£o conflitam<br>
          ‚Ä¢ CSS Variables podem ser usadas para temas
        `;
        result.style.display = 'block';
        log('‚úÖ Isolamento de estilos funcionando', 'success');
      } else {
        status.className = 'status warning';
        status.textContent = 'Parcial';
        result.innerHTML = '<strong>‚ö†Ô∏è Elemento root n√£o encontrado no Shadow DOM.</strong>';
        result.style.display = 'block';
        log('‚ö†Ô∏è Elemento root n√£o encontrado', 'warning');
      }
    }

    function testDOMInspection() {
      log('Test 3: Inspecionando estrutura do DOM...', 'info');
      const status = document.getElementById('status-3');
      const result = document.getElementById('result-3');

      const container = document.querySelector('[id^="__payment_widget_root__"]');

      if (!container) {
        status.className = 'status warning';
        status.textContent = 'Widget n√£o encontrado';
        result.innerHTML = '<strong>‚ö†Ô∏è Widget n√£o inicializado.</strong>';
        result.style.display = 'block';
        log('‚ö†Ô∏è Widget n√£o encontrado para inspe√ß√£o', 'warning');
        return;
      }

      let structure = `<strong>Estrutura do DOM:</strong><br><br>`;
      structure += `<code>div#${container.id}</code> (Container principal)<br>`;

      if (container.shadowRoot) {
        structure += `‚îú‚îÄ <code>#shadow-root (${container.shadowRoot.mode})</code><br>`;

        const children = Array.from(container.shadowRoot.children);
        children.forEach((child, index) => {
          const isLast = index === children.length - 1;
          const prefix = isLast ? '‚îî‚îÄ' : '‚îú‚îÄ';
          structure += `‚îÇ  ${prefix} <code>${child.tagName.toLowerCase()}#${child.id || 'no-id'}</code><br>`;
        });

        log('‚úÖ Estrutura do Shadow DOM mapeada', 'success');
      } else {
        const iframe = container.querySelector('iframe');
        if (iframe) {
          structure += `‚îî‚îÄ <code>iframe#${iframe.id}</code> (Fallback)<br>`;
          log('‚úÖ Estrutura do iframe fallback mapeada', 'success');
        } else {
          structure += `‚îî‚îÄ <em>Nenhum conte√∫do isolado encontrado</em><br>`;
          log('‚ö†Ô∏è Nenhuma estrutura de isolamento encontrada', 'warning');
        }
      }

      status.className = 'status success';
      status.textContent = '‚úÖ Mapeado';
      result.innerHTML = structure;
      result.style.display = 'block';
    }

    // Initial log
    log('üéØ P√°gina de teste do Shadow DOM carregada', 'success');
    log('üëâ Clique em "Inicializar Widget" para come√ßar', 'info');
  </script>
</body>

</html>